VOLUME app_data TYPE=local SIZE=50G
VOLUME app_logs TYPE=bind PATH=/var/log/app

NETWORK dmz TYPE=bridge SUBNET=10.1.0.0/24 GATEWAY=10.1.0.1
NETWORK app TYPE=bridge SUBNET=10.2.0.0/24 GATEWAY=10.2.0.1
NETWORK db TYPE=bridge SUBNET=10.3.0.0/24 GATEWAY=10.3.0.1

SERVICE web COUNT=2 IMAGE=nginx NETWORK=dmz IP_RANGE=10.1.0.10-10.1.0.11 PORTS=80,443
SERVICE api COUNT=3 IMAGE=fastapi NETWORK=app IP_RANGE=10.2.0.10-10.2.0.12 ENV=DEBUG=true,MAX_WORKERS=4
SERVICE database COUNT=1 IMAGE=postgres:14 NETWORK=db IP=10.3.0.10 VOLUMES=app_data=/var/lib/postgresql,app_logs=/logs ENV=POSTGRES_USER=admin,POSTGRES_PASSWORD=secret123

GROUP app_tier MEMBERS=api ROLE=application TIER=backend
GROUP data_tier MEMBERS=database ROLE=database TIER=data
GROUP all_services MEMBERS=web,api,database ROLE=monitoring

ROUTER core_router NETWORKS=dmz,app,db IMAGE=vyos:latest
  INTERFACE eth0 NETWORK=dmz IP=10.1.0.254
  INTERFACE eth1 NETWORK=app IP=10.2.0.254
  INTERFACE eth2 NETWORK=db IP=10.3.0.254

ALLOW dmz -> app PORTS=8000,8001 PROTOCOL=tcp BIDIRECTIONAL=false
ALLOW app -> db PORTS=5432 PROTOCOL=tcp
BLOCK dmz -> db

CREDS api TARGET=database TYPE=database USERNAME=apiuser STRENGTH=strong
CHAIN attack_path PATH=web->api->database TYPE=lateral_movement GOAL=database